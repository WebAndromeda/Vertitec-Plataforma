{% extends 'layouts/navbar.html' %}
{% load static %}

{% block content %}
<center>
    <h1 class="infoTable mt-3" >¬°Hola {{ user.username }}! Bienvenido de nuevo - Rol: Administrador</h1>
    <div class="containerFilter row mb-3 mt-5">
        <div class="col-12">
            <h1 class="titleText">{% if update %}Editar agendamiento{% else %}Crear nuevo agendamiento{%endif%}</h1>
        </div>
    </div>
    

    <!-- Titulos de la tabla -->
    <div class="tableData">
        <div class="row containerTitlesTable">
            <div class="col-1">
                <p class="titlesTable">Recurrencia</p>
            </div>
            <div class="col-3">
                <p class="titlesTable">Edificio</p>
            </div>
            <div class="col-1">
                <p class="titlesTable">Torre</p>
            </div>
            <div class="col-3">
                <p class="titlesTable">T√©cnico</p>
            </div>
            <div class="col-1">
                <p class="titlesTable">Fecha</p>
            </div>
            <div class="col-1">
                <p class="titlesTable">Hora</p>
            </div>
            <div class="col-1">
                <p class="titlesTable">Estado</p>
            </div>
            <div class="col-1">
                <p class="titlesTable">Enviar</p>
            </div>
        </div>
    

        <form action="" method="post">
            {% csrf_token %}
            <div class="row containerInfoTable">
                <div class="col-1 divData">
                    <!-- Recurrencia -->
                    {{ forms.recurrence }}
                    {{ forms.date.errors }}
                </div>
                <div class="col-3 divData">
                    <!-- Edificio -->
                    {{ forms.client }} 
                    <input type="hidden" id="buildingId" name="building_id"> 
                    {{ forms.date.errors }}<br><br>

                </div>
                <div class="col-1 divData">
                    <!-- Torre -->
                    {{ forms.tower }}
                    {{ forms.tower.errors }}<br><br>
                </div>
                <div class="col-3 divData">
                    <!-- T√©cnico -->
                    {{ forms.technician }}
                    {{ forms.technician.errors }}<br><br>
                </div>
                <div class="col-1 divData">
                    <!-- Fecha -->
                    {{ forms.date }} 
                    {{ forms.date.errors }}<br><br>
                </div>
                <div class="col-1 divData">
                    <!-- Hora -->
                    {{ forms.hour }}
                    {{ forms.hour.errors }}<br><br>
                </div>
                <div class="col-1">
                    <!-- Estado -->
                    {{ forms.status }}
                    {{ forms.status.errors }}<br><br>
                </div>
                <div class="col-1">
                    <button class="buttonSendForm" type="submit">
                    {% if update %}Editar{% else %}Crear{% endif %} agendamiento
                    </button><br><br>
                </div>
            </div>
        </form>

        <p class="nota">NOTA: Se puede usar Formsets de Django para esto</p>
        <p class="nota">Si el d√≠a no existe, ajustas al √∫ltimo d√≠a del mes. <br>
            Ejemplo: <br>
            30 enero ‚Üí 28 febrero (o 29 si es bisiesto), 30 marzo, etc. <br>
            31 enero ‚Üí 28/29 febrero, 31 marzo, 30 abril, etc. <br>
            Esto es lo que hacen algunos calendarios (ej. Google Calendar). <br>
            Ventaja: siempre hay un agendamiento cada mes. <br>
            Desventaja: la fecha no siempre coincide en n√∫mero exacto.</p>
        <style>
            .nota{
                color: white;
            }
        </style>

    </div>
</center>

<style>
    /* Contenedor del formulario */
    form {
        position: relative;
    }

    /* Lista de sugerencias */
    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #111c28;
        border: 1px solid white;
        border-top: none;
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none; /* Oculto por defecto */
    }

    /* Cada opci√≥n */
    .suggestions-list li {
        padding: 8px;
        cursor: pointer;
        font-size: 14px;
        color: white;
    }

    /* Hover en opciones */
    .suggestions-list li:hover {
        background-color: #344455;
    }
</style>

<script>
// Script de autocompletado del campo cliente / edificio
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buildingInput");
    const towerSelect = document.getElementById("id_tower");

    // Crear la lista de sugerencias
    const suggestionBox = document.createElement("ul");
    suggestionBox.classList.add("suggestions-list");

    // Insertamos despu√©s del input
    input.parentNode.appendChild(suggestionBox);

    input.addEventListener("input", function () {
        const query = input.value.trim();
        if (query.length < 2) {
            suggestionBox.style.display = "none";
            return;
        }

        fetch(`/building-suggestions/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                suggestionBox.innerHTML = "";
                if (data.length > 0) {
                    data.forEach(item => {
                        const li = document.createElement("li");
                        li.textContent = item.first_name;

                        // Guardamos tambi√©n el id del edificio
                        li.dataset.buildingId = item.id;

                        li.addEventListener("mousedown", function () {
                            input.value = item.first_name;
                            suggestionBox.style.display = "none";

                            // üîΩ Actualizar torres seg√∫n el edificio seleccionado
                            const buildingId = li.dataset.buildingId;
                            fetch(`/tower-suggestions/?building_id=${buildingId}`)
                                .then(response => response.json())
                                .then(towers => {
                                    towerSelect.innerHTML = ""; // limpiar torres previas

                                    if (towers.length > 0) {
                                        const defaultOption = document.createElement("option");
                                        defaultOption.value = "";
                                        defaultOption.textContent = "Selecciona una torre";
                                        towerSelect.appendChild(defaultOption);

                                        towers.forEach(tower => {
                                            const option = document.createElement("option");
                                            option.value = tower.id;
                                            option.textContent = tower.name;
                                            towerSelect.appendChild(option);
                                        });
                                    } else {
                                        const option = document.createElement("option");
                                        option.value = "";
                                        option.textContent = "Sin torres disponibles";
                                        towerSelect.appendChild(option);
                                    }
                                });
                        });

                        suggestionBox.appendChild(li);
                    });
                    suggestionBox.style.display = "block";
                } else {
                    suggestionBox.style.display = "none";
                }
            });
    });

    // Ocultar sugerencias si se hace clic afuera
    document.addEventListener("click", function (e) {
        if (e.target !== input && !suggestionBox.contains(e.target)) {
            suggestionBox.style.display = "none";
        }
    });
});
</script>


<script>
// Script para confirmar que se creara un agendamiento con una fecha u hora anterior a la actual
document.querySelector("form").addEventListener("submit", function(e) {
    let date = document.querySelector("input[name='date']").value;
    let hour = document.querySelector("input[name='hour']").value;
    if (date && hour) {
        let selected = new Date(date + "T" + hour);
        let now = new Date();
        if (selected < now) {
            if (!confirm("‚ö†Ô∏è Est√°s agendando en una fecha u hora pasada, ¬øQuieres continuar?")) {
                e.preventDefault();
            }
        }
    }
});
</script>
{% endblock %}
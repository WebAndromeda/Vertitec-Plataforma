{% extends 'layouts/navbar.html' %}
{% load static %}

{% block content %}
<center>
    <h1 class="infoTable mt-3" >Â¡Hola {{ user.first_name }} {{ user.last_name }}! Bienvenido de nuevo - Rol: {{ user.groups.all.0.name|default:"Sin Rol" }}</h1>
    <div class="containerFilter row mb-3 mt-5">
        <div class="col-12">
            <h1 class="titleText">{% if update %}Editar agendamiento{% else %}Crear nuevo agendamiento{%endif%}</h1>
        </div>
    </div>
    
    <!-- Formulario para administradores -->
    {% if user.groups.all.0.name == "Administrador" %}
        <!-- Titulos de la tabla -->
        <div class="tableData">
            <div class="row containerTitlesTable">
                <div class="col-1">
                    <p class="titlesTable">Recurrencia</p>
                </div>
                <div class="col-3">
                    <p class="titlesTable">Edificio</p>
                </div>
                <div class="col-1">
                    <p class="titlesTable">Torre</p>
                </div>
                <div class="col-3">
                    <p class="titlesTable">TÃ©cnico</p>
                </div>
                <div class="col-1">
                    <p class="titlesTable">Fecha</p>
                </div>
                <div class="col-1">
                    <p class="titlesTable">Hora</p>
                </div>
                <div class="col-1">
                    <p class="titlesTable">Estado</p>
                </div>
                <div class="col-1">
                    <p class="titlesTable">Enviar</p>
                </div>
            </div>
        

            <!-- Mostrar messages de django (si los hay) -->
            {% if messages %}
            <div>
                {% for message in messages %}
                <div class="alert 
                    {% if message.tags == 'error' %}alert-danger
                    {% elif message.tags == 'warning' %}alert-warning
                    {% elif message.tags == 'success' %}alert-success
                    {% else %}alert-info{% endif %}"
                    style="padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Mostrar errores no ligados a campo (form.non_field_errors) -->
            {% if forms.non_field_errors %}
                <div class="alert alert-danger" style="padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    {% for err in forms.non_field_errors %}
                        <p>{{ err }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <form action="" method="post">
                {% csrf_token %}
                <div class="row containerInfoTable">
                    <div class="col-1 divData">
                    {{ forms.recurrence }}
                    {{ forms.recurrence.errors }}
                    </div>

                    <div class="col-3 divData">
                    {{ forms.client }}
                    <input type="hidden" id="buildingId" name="building_id">
                    {{ forms.client.errors }}
                    </div>

                    <div class="col-1 divData">
                    {{ forms.tower }}
                    {{ forms.tower.errors }}
                    </div>

                    <div class="col-3 divData">
                    {{ forms.technician }}
                    {{ forms.technician.errors }}
                    </div>

                    <div class="col-1 divData">
                    {{ forms.date }}
                    {{ forms.date.errors }}
                    </div>

                    <div class="col-1 divData">
                    {{ forms.hour }}
                    {{ forms.hour.errors }}
                    </div>

                    <div class="col-1 divData">
                    {{ forms.status }}
                    {{ forms.status.errors }}
                    </div>

                    <div class="col-1 divData">
                    <button class="buttonSendForm" type="submit">
                        {% if update %}Editar{% else %}Crear{% endif %} agendamiento
                    </button>
                    </div>
                </div>

                <!-- Flag oculto para permitir un segundo intento tras advertencia -->
                {% if confirm_warning %}
                    <input type="hidden" name="confirm_warning" value="1">
                {% endif %}
            </form>
        </div>
    {% endif %}


    <!-- Formulario para tÃ©cnicos -->
{% if user.groups.all.0.name == "TÃ©cnico" %}
    <div class="tableData">

        <!-- Mostrar messages de Django (Ã©xitos, advertencias, errores) -->
        {% if messages %}
        <div style="margin-bottom: 15px;">
            {% for message in messages %}
            <div class="alert 
                {% if message.tags == 'error' %}alert-danger
                {% elif message.tags == 'warning' %}alert-warning
                {% elif message.tags == 'success' %}alert-success
                {% else %}alert-info{% endif %}"
                style="padding: 10px; border-radius: 5px;">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Mostrar errores no ligados a campo -->
        {% if forms.non_field_errors %}
        <div class="alert alert-danger" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            {% for err in forms.non_field_errors %}
                <p>{{ err }}</p>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Titulos de la tabla -->
        <div class="row containerTitlesTable">
            <div class="col-3"><p class="titlesTable">Edificio</p></div>
            <div class="col-3"><p class="titlesTable">Torre</p></div>
            <div class="col-2"><p class="titlesTable">Fecha</p></div>
            <div class="col-2"><p class="titlesTable">Hora</p></div>
            <div class="col-2"><p class="titlesTable">Enviar</p></div>
        </div>

        <!-- Formulario -->
        <form action="" method="post">
            {% csrf_token %}
            <div class="row containerInfoTable">

                <div class="col-3 divData">
                    {{ forms.client }}
                    <input type="hidden" id="buildingId" name="building_id">
                    {{ forms.client.errors }}
                </div>

                <div class="col-3 divData">
                    {{ forms.tower }}
                    {{ forms.tower.errors }}
                </div>

                <div class="col-2 divData">
                    {{ forms.date }}
                    {{ forms.date.errors }}
                </div>

                <div class="col-2 divData">
                    {{ forms.hour }}
                    {{ forms.hour.errors }}
                </div>

                <div class="col-2 divData">
                    <button class="buttonSendForm" type="submit">
                        {% if update %}Editar{% else %}Crear{% endif %} agendamiento
                    </button>
                </div>
            </div>

            <!-- Flag oculto para permitir un segundo intento tras advertencia -->
            {% if confirm_warning %}
                <input type="hidden" name="confirm_warning" value="1">
            {% endif %}
        </form>
    </div>
{% endif %}

</center>

<style>
    /* Contenedor del formulario */
    form {
        position: relative;
    }

    /* Lista de sugerencias */
    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #111c28;
        border: 1px solid white;
        border-top: none;
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none; /* Oculto por defecto */
    }

    /* Cada opciÃ³n */
    .suggestions-list li {
        padding: 8px;
        cursor: pointer;
        font-size: 14px;
        color: white;
    }

    /* Hover en opciones */
    .suggestions-list li:hover {
        background-color: #344455;
    }
</style>

<script>
    // Script de autocompletado del campo cliente / edificio
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("buildingInput");
        const towerSelect = document.getElementById("id_tower");

        // Crear la lista de sugerencias
        const suggestionBox = document.createElement("ul");
        suggestionBox.classList.add("suggestions-list");

        // Insertamos despuÃ©s del input
        input.parentNode.appendChild(suggestionBox);

        input.addEventListener("input", function () {
            const query = input.value.trim();
            if (query.length < 2) {
                suggestionBox.style.display = "none";
                return;
            }

            fetch(`/building-suggestions/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    suggestionBox.innerHTML = "";
                    if (data.length > 0) {
                        data.forEach(item => {
                            const li = document.createElement("li");
                            li.textContent = item.first_name;

                            // Guardamos tambiÃ©n el id del edificio
                            li.dataset.buildingId = item.id;

                            li.addEventListener("mousedown", function () {
                                input.value = item.first_name;
                                suggestionBox.style.display = "none";

                                // ðŸ”½ Actualizar torres segÃºn el edificio seleccionado
                                const buildingId = li.dataset.buildingId;
                                fetch(`/tower-suggestions/?building_id=${buildingId}`)
                                    .then(response => response.json())
                                    .then(towers => {
                                        towerSelect.innerHTML = ""; // limpiar torres previas

                                        if (towers.length > 0) {
                                            const defaultOption = document.createElement("option");
                                            defaultOption.value = "";
                                            defaultOption.textContent = "Selecciona una torre";
                                            towerSelect.appendChild(defaultOption);

                                            towers.forEach(tower => {
                                                const option = document.createElement("option");
                                                option.value = tower.id;
                                                option.textContent = tower.name;
                                                towerSelect.appendChild(option);
                                            });
                                        } else {
                                            const option = document.createElement("option");
                                            option.value = "";
                                            option.textContent = "Sin torres disponibles";
                                            towerSelect.appendChild(option);
                                        }
                                    });
                            });

                            suggestionBox.appendChild(li);
                        });
                        suggestionBox.style.display = "block";
                    } else {
                        suggestionBox.style.display = "none";
                    }
                });
        });

        // Ocultar sugerencias si se hace clic afuera
        document.addEventListener("click", function (e) {
            if (e.target !== input && !suggestionBox.contains(e.target)) {
                suggestionBox.style.display = "none";
            }
        });
    });
</script>


<script>
    // Script para confirmar que se creara un agendamiento con una fecha u hora anterior a la actual
    document.querySelector("form").addEventListener("submit", function(e) {
        let date = document.querySelector("input[name='date']").value;
        let hour = document.querySelector("input[name='hour']").value;
        if (date && hour) {
            let selected = new Date(date + "T" + hour);
            let now = new Date();
            if (selected < now) {
                if (!confirm("âš ï¸ EstÃ¡s agendando en una fecha u hora pasada, Â¿Quieres continuar?")) {
                    e.preventDefault();
                }
            }
        }
    });
</script>
{% endblock %}